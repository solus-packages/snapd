From 0e0dc3261e4189f26dafacb1f5d567f16a9c7b19 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sun, 28 Jan 2018 19:31:35 +0000
Subject: [PATCH] snap-confine/nvidia: Support legacy biarch trees for GLVND
 systems

GLVND systems are well catered for on biarch configurations, however the
older 304 + 340 series will rely on ld.so.conf tricks to mask the system
libGL.so with one in the private `libdir/nvidia*/` files. This is seen
consistently across Arch, Fedora and Solus. As such we allow these fallback
paths to work so that users of snapd on glvnd enabled distros with the older
legacy drivers can still enjoy snapd + NVIDIA together.

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 cmd/snap-confine/mount-support-nvidia.c | 16 ++++++++++++++++
 interfaces/builtin/opengl.go            |  2 +-
 2 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/cmd/snap-confine/mount-support-nvidia.c b/cmd/snap-confine/mount-support-nvidia.c
index 42f56c3dc..0bb50f511 100644
--- a/cmd/snap-confine/mount-support-nvidia.c
+++ b/cmd/snap-confine/mount-support-nvidia.c
@@ -96,6 +96,10 @@ static const char *nvidia_globs[] = {
 	"/usr/lib/libnvidia-ptxjitcompiler.so*",
 	"/usr/lib/libnvidia-tls.so*",
 	"/usr/lib/vdpau/libvdpau_nvidia.so*",
+	"/usr/lib/nvidia*/libGL.so*"
+	"/usr/lib/nvidia*/libEGL.so*"
+	"/usr/lib/nvidia*/libGLESv1_CM.so*",
+	"/usr/lib/nvidia*/libGLESv2.so*",
 };
 
 static const size_t nvidia_globs_len =
@@ -133,6 +137,10 @@ static const char *nvidia_globs32[] = {
 	"/usr/lib32/libnvidia-ptxjitcompiler.so*",
 	"/usr/lib32/libnvidia-tls.so*",
 	"/usr/lib32/vdpau/libvdpau_nvidia.so*",
+	"/usr/lib32/nvidia*/libGL.so*"
+	"/usr/lib32/nvidia*/libEGL.so*"
+	"/usr/lib32/nvidia*/libGLESv1_CM.so*",
+	"/usr/lib32/nvidia*/libGLESv2.so*",
 };
 
 static const size_t nvidia_globs32_len =
@@ -216,6 +224,14 @@ static void sc_populate_libgl_with_hostfs_symlinks(const char *libgl_dir,
 				 "%s/%s", libgl_dir, filename);
 		debug("creating symbolic link %s -> %s", symlink_name,
 		      symlink_target);
+
+		// Make sure we don't have some link already (merged GLVND systems)
+		if (lstat(symlink_target, &stat_buf) == 0) {
+			if (unlink(symlink_target) != 0) {
+				die("cannot remove symbolic link target %s", symlink_target);
+			}
+		}
+
 		if (symlink(symlink_target, symlink_name) != 0) {
 			die("cannot create symbolic link %s -> %s",
 			    symlink_name, symlink_target);
diff --git a/interfaces/builtin/opengl.go b/interfaces/builtin/opengl.go
index bd6588157..362583527 100644
--- a/interfaces/builtin/opengl.go
+++ b/interfaces/builtin/opengl.go
@@ -48,7 +48,7 @@ const openglConnectedPlugAppArmor = `
 /var/lib/snapd/hostfs/usr/share/vulkan/icd.d/*nvidia*.json r,
 
 # Main bi-arch GL libraries
-/var/lib/snapd/hostfs/{,usr/}lib{,32,64,x32}/{,@{multiarch}/}lib{GL,EGL,GLX}.so{,.*} rm,
+/var/lib/snapd/hostfs/{,usr/}lib{,32,64,x32}/{,@{multiarch}/}{,nvidia*/}lib{GL,EGL,GLX}.so{,.*} rm,
 
 /dev/dri/ r,
 /dev/dri/card0 rw,
-- 
2.16.1

